{"ast":null,"code":"import _asyncToGenerator from \"/Users/cferte/Work/test-tuto/potatoDAO/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport _classCallCheck from \"/Users/cferte/Work/test-tuto/potatoDAO/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"/Users/cferte/Work/test-tuto/potatoDAO/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport _regeneratorRuntime from \"/Users/cferte/Work/test-tuto/potatoDAO/node_modules/@babel/runtime/regenerator/index.js\";\nimport { EventEmitter } from \"events\";\nimport fetch from \"cross-fetch\";\nimport { safeJsonParse, safeJsonStringify } from \"@walletconnect/safe-json\";\nimport { formatJsonRpcError, isHttpUrl, parseConnectionError } from \"@walletconnect/jsonrpc-utils\";\nvar DEFAULT_HTTP_HEADERS = {\n  Accept: \"application/json\",\n  \"Content-Type\": \"application/json\"\n};\nvar DEFAULT_HTTP_METHOD = \"POST\";\nvar DEFAULT_FETCH_OPTS = {\n  headers: DEFAULT_HTTP_HEADERS,\n  method: DEFAULT_HTTP_METHOD\n};\nexport var HttpConnection = /*#__PURE__*/function () {\n  function HttpConnection(url) {\n    _classCallCheck(this, HttpConnection);\n\n    this.url = url;\n    this.events = new EventEmitter();\n    this.isAvailable = false;\n    this.registering = false;\n\n    if (!isHttpUrl(url)) {\n      throw new Error(\"Provided URL is not compatible with HTTP connection: \".concat(url));\n    }\n\n    this.url = url;\n  }\n\n  _createClass(HttpConnection, [{\n    key: \"connected\",\n    get: function get() {\n      return this.isAvailable;\n    }\n  }, {\n    key: \"connecting\",\n    get: function get() {\n      return this.registering;\n    }\n  }, {\n    key: \"on\",\n    value: function on(event, listener) {\n      this.events.on(event, listener);\n    }\n  }, {\n    key: \"once\",\n    value: function once(event, listener) {\n      this.events.once(event, listener);\n    }\n  }, {\n    key: \"off\",\n    value: function off(event, listener) {\n      this.events.off(event, listener);\n    }\n  }, {\n    key: \"removeListener\",\n    value: function removeListener(event, listener) {\n      this.events.removeListener(event, listener);\n    }\n  }, {\n    key: \"open\",\n    value: function () {\n      var _open = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee() {\n        var url,\n            _args = arguments;\n        return _regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                url = _args.length > 0 && _args[0] !== undefined ? _args[0] : this.url;\n                _context.next = 3;\n                return this.register(url);\n\n              case 3:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function open() {\n        return _open.apply(this, arguments);\n      }\n\n      return open;\n    }()\n  }, {\n    key: \"close\",\n    value: function () {\n      var _close = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee2() {\n        return _regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                if (this.isAvailable) {\n                  _context2.next = 2;\n                  break;\n                }\n\n                throw new Error(\"Connection already closed\");\n\n              case 2:\n                this.onClose();\n\n              case 3:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function close() {\n        return _close.apply(this, arguments);\n      }\n\n      return close;\n    }()\n  }, {\n    key: \"send\",\n    value: function () {\n      var _send = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee3(payload, context) {\n        var body, res, data;\n        return _regeneratorRuntime.wrap(function _callee3$(_context3) {\n          while (1) {\n            switch (_context3.prev = _context3.next) {\n              case 0:\n                if (this.isAvailable) {\n                  _context3.next = 3;\n                  break;\n                }\n\n                _context3.next = 3;\n                return this.register();\n\n              case 3:\n                _context3.prev = 3;\n                body = safeJsonStringify(payload);\n                _context3.next = 7;\n                return fetch(this.url, Object.assign(Object.assign({}, DEFAULT_FETCH_OPTS), {\n                  body: body\n                }));\n\n              case 7:\n                res = _context3.sent;\n                _context3.next = 10;\n                return res.json();\n\n              case 10:\n                data = _context3.sent;\n                this.onPayload({\n                  data: data\n                });\n                _context3.next = 17;\n                break;\n\n              case 14:\n                _context3.prev = 14;\n                _context3.t0 = _context3[\"catch\"](3);\n                this.onError(payload.id, _context3.t0);\n\n              case 17:\n              case \"end\":\n                return _context3.stop();\n            }\n          }\n        }, _callee3, this, [[3, 14]]);\n      }));\n\n      function send(_x, _x2) {\n        return _send.apply(this, arguments);\n      }\n\n      return send;\n    }()\n  }, {\n    key: \"register\",\n    value: function () {\n      var _register = _asyncToGenerator( /*#__PURE__*/_regeneratorRuntime.mark(function _callee4() {\n        var _this = this;\n\n        var url,\n            body,\n            error,\n            _args4 = arguments;\n        return _regeneratorRuntime.wrap(function _callee4$(_context4) {\n          while (1) {\n            switch (_context4.prev = _context4.next) {\n              case 0:\n                url = _args4.length > 0 && _args4[0] !== undefined ? _args4[0] : this.url;\n\n                if (isHttpUrl(url)) {\n                  _context4.next = 3;\n                  break;\n                }\n\n                throw new Error(\"Provided URL is not compatible with HTTP connection: \".concat(url));\n\n              case 3:\n                if (!this.registering) {\n                  _context4.next = 5;\n                  break;\n                }\n\n                return _context4.abrupt(\"return\", new Promise(function (resolve, reject) {\n                  _this.events.once(\"register_error\", function (error) {\n                    reject(error);\n                  });\n\n                  _this.events.once(\"open\", function () {\n                    if (typeof _this.isAvailable === \"undefined\") {\n                      return reject(new Error(\"HTTP connection is missing or invalid\"));\n                    }\n\n                    resolve();\n                  });\n                }));\n\n              case 5:\n                this.url = url;\n                this.registering = true;\n                _context4.prev = 7;\n                body = safeJsonStringify({\n                  id: 1,\n                  jsonrpc: \"2.0\",\n                  method: \"test\",\n                  params: []\n                });\n                _context4.next = 11;\n                return fetch(url, Object.assign(Object.assign({}, DEFAULT_FETCH_OPTS), {\n                  body: body\n                }));\n\n              case 11:\n                this.onOpen();\n                _context4.next = 20;\n                break;\n\n              case 14:\n                _context4.prev = 14;\n                _context4.t0 = _context4[\"catch\"](7);\n                error = this.parseError(_context4.t0);\n                this.events.emit(\"register_error\", error);\n                this.onClose();\n                throw error;\n\n              case 20:\n              case \"end\":\n                return _context4.stop();\n            }\n          }\n        }, _callee4, this, [[7, 14]]);\n      }));\n\n      function register() {\n        return _register.apply(this, arguments);\n      }\n\n      return register;\n    }()\n  }, {\n    key: \"onOpen\",\n    value: function onOpen() {\n      this.isAvailable = true;\n      this.registering = false;\n      this.events.emit(\"open\");\n    }\n  }, {\n    key: \"onClose\",\n    value: function onClose() {\n      this.isAvailable = false;\n      this.registering = false;\n      this.events.emit(\"close\");\n    }\n  }, {\n    key: \"onPayload\",\n    value: function onPayload(e) {\n      if (typeof e.data === \"undefined\") return;\n      var payload = typeof e.data === \"string\" ? safeJsonParse(e.data) : e.data;\n      this.events.emit(\"payload\", payload);\n    }\n  }, {\n    key: \"onError\",\n    value: function onError(id, e) {\n      var error = this.parseError(e);\n      var message = error.message || error.toString();\n      var payload = formatJsonRpcError(id, message);\n      this.events.emit(\"payload\", payload);\n    }\n  }, {\n    key: \"parseError\",\n    value: function parseError(e) {\n      var url = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : this.url;\n      return parseConnectionError(e, url, \"HTTP\");\n    }\n  }]);\n\n  return HttpConnection;\n}();\nexport default HttpConnection;","map":{"version":3,"mappings":"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","names":["EventEmitter","fetch","safeJsonParse","safeJsonStringify","formatJsonRpcError","isHttpUrl","parseConnectionError","DEFAULT_HTTP_HEADERS","Accept","DEFAULT_HTTP_METHOD","DEFAULT_FETCH_OPTS","headers","method","HttpConnection","url","Error","isAvailable","registering","event","listener","events","on","once","off","removeListener","register","onClose","payload","context","body","Object","res","json","data","onPayload","onError","id","Promise","resolve","reject","error","jsonrpc","params","onOpen","parseError","emit","e","message","toString"],"sourceRoot":"","sources":["../../src/http.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}